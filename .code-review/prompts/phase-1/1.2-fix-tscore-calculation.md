# Milestone 1.2: Fix T-Score Calculation Bug

> **Phase:** 1 - Critical Bug Fixes
> **Priority:** CRITICAL
> **Status:** Pending
> **Last Updated:** 2025-12-27

---

## Problem Description

The T-Score calculation in `AssessmentController` does not properly filter out unanswered questions (value = -1), leading to incorrect negative scores.

### Current Code (lib/screens/child/assessment/controllers/assessment_controller.dart)

```dart
Future<void> _showResults() async {
  // ...
  final score = answers.asMap().entries.fold<int>(
    0,
    (sum, entry) => sum + entry.value,  // BUG: Includes -1 values
  );
  // ...
}
```

### The Issue

- Unanswered questions are stored as `-1`
- The fold operation sums ALL values including `-1`
- This produces incorrect negative or reduced scores

---

## Required Changes

### Step 1: Read the affected files

```
Read: D:\khuta\lib\screens\child\assessment\controllers\assessment_controller.dart
Read: D:\khuta\lib\screens\child\assessment\services\assessment_service.dart
```

### Step 2: Fix the calculation in AssessmentController

Find the `_showResults()` method and update the score calculation:

**Before:**
```dart
final score = answers.asMap().entries.fold<int>(
  0,
  (sum, entry) => sum + entry.value,
);
```

**After:**
```dart
// Filter out unanswered questions (-1) before summing
final score = answers.where((answer) => answer >= 0).fold<int>(
  0,
  (sum, answer) => sum + answer,
);
```

### Step 3: Add validation to prevent incomplete submissions

Add a check before showing results:

```dart
Future<void> _showResults() async {
  if (questions.isEmpty) return;

  // Validate all questions are answered
  final unansweredCount = answers.where((a) => a < 0).length;
  if (unansweredCount > 0) {
    if (!context.mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('please_answer_all_questions'.tr()),
        backgroundColor: Colors.orange,
      ),
    );
    return;
  }

  // Continue with results...
}
```

### Step 4: Add translation key

Add to `assets/translations/en.json`:
```json
"please_answer_all_questions": "Please answer all questions before submitting"
```

Add to `assets/translations/ar.json`:
```json
"please_answer_all_questions": "يرجى الإجابة على جميع الأسئلة قبل الإرسال"
```

### Step 5: Verify the fix

```bash
flutter analyze
flutter test test/cubit/auth/auth_cubit_test.dart
```

---

## Acceptance Criteria

- [ ] Score calculation only sums valid answers (≥ 0)
- [ ] Users cannot submit incomplete assessments
- [ ] Translation keys added for both languages
- [ ] `flutter analyze` passes

---

## Files to Modify

| File | Action |
|------|--------|
| `lib/screens/child/assessment/controllers/assessment_controller.dart` | Fix score calculation |
| `assets/translations/en.json` | Add validation message |
| `assets/translations/ar.json` | Add validation message |

---

## Testing

Create a unit test for score calculation:

```dart
// test/services/score_calculation_test.dart
void main() {
  test('Score calculation ignores unanswered questions', () {
    final answers = [0, 1, 2, -1, 3, -1, 2];
    final score = answers.where((a) => a >= 0).fold<int>(0, (sum, a) => sum + a);
    expect(score, equals(8)); // 0+1+2+3+2 = 8, not 6
  });
}
```

---

## Progress Tracking

- [ ] Step 1: Read affected files
- [ ] Step 2: Fix score calculation
- [ ] Step 3: Add validation
- [ ] Step 4: Add translation keys
- [ ] Step 5: Run tests
- [ ] Step 6: Update checklist

---

## Completion

When done, update:
1. `.code-review/MASTER_PLAN.md` - Change milestone 1.2 status to "Done"
2. `.code-review/checklists/phase-1-checklist.md` - Mark item complete
