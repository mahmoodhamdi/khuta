# Milestone 1.1: Fix Duplicate Initialization in main.dart

> **Phase:** 1 - Critical Bug Fixes
> **Priority:** CRITICAL
> **Status:** Pending
> **Last Updated:** 2025-12-27

---

## Problem Description

The `lib/main.dart` file contains duplicate initialization calls that cause:
1. Resource overhead during app startup
2. Potential initialization conflicts
3. Firebase being initialized twice

### Current Code (Lines 19-27)

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();  // First call
  await EasyLocalization.ensureInitialized();
    WidgetsFlutterBinding.ensureInitialized();  // DUPLICATE - unnecessary
  await Firebase.initializeApp();  // First Firebase init - no options
  await FirebaseAppCheck.instance.activate(
    providerAndroid: const AndroidDebugProvider(),
  );
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);  // DUPLICATE Firebase init
  // ...
}
```

---

## Required Changes

### Step 1: Read the current file
```
Read: D:\khuta\lib\main.dart
```

### Step 2: Fix the initialization sequence

Replace the duplicate initialization code with:

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await EasyLocalization.ensureInitialized();

  // Initialize Firebase once with proper options
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

  // Activate App Check after Firebase is initialized
  await FirebaseAppCheck.instance.activate(
    providerAndroid: const AndroidDebugProvider(),
  );

  // Set preferred orientations
  await SystemChrome.setPreferredOrientations([
    DeviceOrientation.portraitUp,
    DeviceOrientation.portraitDown,
  ]);

  // Initialize SharedPreferences for theme and onboarding
  final prefs = await SharedPreferences.getInstance();

  runApp(
    // ... rest of the code
  );
}
```

### Step 3: Verify the fix

Run:
```bash
flutter analyze lib/main.dart
```

---

## Acceptance Criteria

- [ ] `WidgetsFlutterBinding.ensureInitialized()` called only once
- [ ] `Firebase.initializeApp()` called only once with options
- [ ] App starts without errors
- [ ] `flutter analyze` passes for main.dart

---

## Files to Modify

| File | Action |
|------|--------|
| `lib/main.dart` | Fix duplicate initialization |

---

## Testing

After making changes:
1. Run `flutter analyze`
2. Run `flutter run` to verify app starts correctly
3. Verify Firebase connection works (login/register)

---

## Progress Tracking

- [ ] Step 1: Read current file
- [ ] Step 2: Apply fix
- [ ] Step 3: Run flutter analyze
- [ ] Step 4: Test app startup
- [ ] Step 5: Update checklist

---

## Completion

When done, update:
1. `.code-review/MASTER_PLAN.md` - Change milestone 1.1 status to "Done"
2. `.code-review/checklists/phase-1-checklist.md` - Mark item complete
3. `.code-review/PROGRESS.md` - Add completion note
