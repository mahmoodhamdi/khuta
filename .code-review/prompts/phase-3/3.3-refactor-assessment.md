# Milestone 3.3: Refactor Assessment Flow

> **Phase:** 3 - Code Quality & Architecture
> **Priority:** MEDIUM
> **Status:** Pending
> **Last Updated:** 2025-12-27

---

## Problem Description

The `AssessmentController` is a "god object" handling navigation, state, and business logic. It needs to be split for better maintainability.

---

## Required Changes

### Step 1: Create AssessmentCubit for state management

Create `lib/cubit/assessment/assessment_cubit.dart`:

```dart
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:equatable/equatable.dart';
import 'package:khuta/models/question.dart';
import 'package:khuta/models/child.dart';

part 'assessment_state.dart';

class AssessmentCubit extends Cubit<AssessmentState> {
  final Child child;
  final List<Question> questions;

  AssessmentCubit({
    required this.child,
    required this.questions,
  }) : super(AssessmentState.initial(questions.length));

  void selectAnswer(int questionIndex, int answerIndex) {
    final newAnswers = List<int>.from(state.answers);
    newAnswers[questionIndex] = answerIndex;
    emit(state.copyWith(answers: newAnswers));
  }

  void nextQuestion() {
    if (state.currentIndex < questions.length - 1) {
      emit(state.copyWith(currentIndex: state.currentIndex + 1));
    }
  }

  void previousQuestion() {
    if (state.currentIndex > 0) {
      emit(state.copyWith(currentIndex: state.currentIndex - 1));
    }
  }

  bool get isLastQuestion => state.currentIndex == questions.length - 1;
  bool get isFirstQuestion => state.currentIndex == 0;
  bool get canProceed => state.answers[state.currentIndex] >= 0;
  bool get allQuestionsAnswered => !state.answers.contains(-1);

  int calculateScore() {
    return state.answers.where((a) => a >= 0).fold(0, (sum, a) => sum + a);
  }
}
```

Create `lib/cubit/assessment/assessment_state.dart`:

```dart
part of 'assessment_cubit.dart';

class AssessmentState extends Equatable {
  final int currentIndex;
  final List<int> answers;
  final bool isSubmitting;
  final String? error;

  const AssessmentState({
    required this.currentIndex,
    required this.answers,
    this.isSubmitting = false,
    this.error,
  });

  factory AssessmentState.initial(int questionCount) {
    return AssessmentState(
      currentIndex: 0,
      answers: List.filled(questionCount, -1),
    );
  }

  AssessmentState copyWith({
    int? currentIndex,
    List<int>? answers,
    bool? isSubmitting,
    String? error,
  }) {
    return AssessmentState(
      currentIndex: currentIndex ?? this.currentIndex,
      answers: answers ?? this.answers,
      isSubmitting: isSubmitting ?? this.isSubmitting,
      error: error,
    );
  }

  @override
  List<Object?> get props => [currentIndex, answers, isSubmitting, error];
}
```

### Step 2: Create AssessmentService for business logic

Update `lib/screens/child/assessment/services/assessment_service.dart`:

```dart
class AssessmentService {
  final ChildRepository _childRepository;
  final TestResultRepository _testResultRepository;

  AssessmentService({
    ChildRepository? childRepository,
    TestResultRepository? testResultRepository,
  })  : _childRepository = childRepository ?? ServiceLocator().childRepository,
        _testResultRepository = testResultRepository ?? ServiceLocator().testResultRepository;

  Future<int> calculateTScore({
    required List<int> answers,
    required Child child,
    required String assessmentType,
  }) async {
    return SdqScoringService.calculateTScore(
      answers: answers,
      gender: child.gender,
      age: child.age,
      assessmentType: assessmentType,
    );
  }

  Future<List<String>> getRecommendations({
    required int tScore,
    required List<Question> questions,
    required List<int> answers,
    required Child child,
  }) async {
    return AiRecommendationsService.getRecommendations(
      tScore,
      questions,
      answers,
      childAge: child.age,
      childGender: child.gender,
    );
  }

  Future<void> saveResult({
    required String childId,
    required int score,
    required String interpretation,
    required List<String> recommendations,
    required String assessmentType,
  }) async {
    final result = TestResult(
      score: score,
      interpretation: interpretation,
      recommendations: recommendations,
      assessmentType: assessmentType,
      date: DateTime.now(),
    );
    await _testResultRepository.saveTestResult(childId, result);
  }
}
```

### Step 3: Update AssessmentScreen to use Cubit

```dart
class AssessmentScreen extends StatelessWidget {
  final Child child;
  final List<Question> questions;

  const AssessmentScreen({
    super.key,
    required this.child,
    required this.questions,
  });

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (context) => AssessmentCubit(child: child, questions: questions),
      child: const _AssessmentView(),
    );
  }
}

class _AssessmentView extends StatelessWidget {
  const _AssessmentView();

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<AssessmentCubit, AssessmentState>(
      builder: (context, state) {
        final cubit = context.read<AssessmentCubit>();
        // Build UI using cubit methods and state
      },
    );
  }
}
```

---

## Files to Create/Modify

| File | Action |
|------|--------|
| `lib/cubit/assessment/assessment_cubit.dart` | Create |
| `lib/cubit/assessment/assessment_state.dart` | Create |
| `lib/screens/child/assessment/services/assessment_service.dart` | Refactor |
| `lib/screens/child/assessment/assessment_screen.dart` | Update to use Cubit |
| `lib/screens/child/assessment/controllers/assessment_controller.dart` | Delete after migration |

---

## Acceptance Criteria

- [ ] AssessmentCubit manages state
- [ ] AssessmentService handles business logic
- [ ] Clear separation of concerns
- [ ] All tests pass
- [ ] `flutter analyze` passes

---

## Progress Tracking

- [ ] Step 1: Create AssessmentCubit
- [ ] Step 2: Refactor AssessmentService
- [ ] Step 3: Update AssessmentScreen
- [ ] Step 4: Delete old controller
- [ ] Step 5: Test assessment flow
- [ ] Step 6: Update checklist
