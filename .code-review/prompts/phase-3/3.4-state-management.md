# Milestone 3.4: State Management Improvements

> **Phase:** 3 - Code Quality & Architecture
> **Priority:** MEDIUM
> **Status:** Done
> **Last Updated:** 2025-12-27

---

## Problem Description

1. No state persistence on app restart
2. Premature state emissions in some places
3. Missing loading states in some screens

---

## Required Changes

### Step 1: Create ChildCubit for home screen

```dart
// lib/cubit/child/child_cubit.dart
class ChildCubit extends Cubit<ChildState> {
  final ChildRepository _repository;

  ChildCubit({ChildRepository? repository})
      : _repository = repository ?? ServiceLocator().childRepository,
        super(const ChildState.initial());

  Future<void> loadChildren() async {
    emit(state.copyWith(status: ChildStatus.loading));
    try {
      final children = await _repository.getChildren();
      emit(state.copyWith(status: ChildStatus.loaded, children: children));
    } catch (e) {
      emit(state.copyWith(status: ChildStatus.error, error: e.toString()));
    }
  }

  Future<void> deleteChild(String childId) async {
    try {
      await _repository.deleteChild(childId);
      await loadChildren();
    } catch (e) {
      emit(state.copyWith(error: e.toString()));
    }
  }
}
```

### Step 2: Create proper loading states

```dart
// lib/cubit/child/child_state.dart
enum ChildStatus { initial, loading, loaded, error }

class ChildState extends Equatable {
  final ChildStatus status;
  final List<Child> children;
  final String? error;

  const ChildState({
    required this.status,
    required this.children,
    this.error,
  });

  const ChildState.initial()
      : status = ChildStatus.initial,
        children = const [],
        error = null;

  ChildState copyWith({
    ChildStatus? status,
    List<Child>? children,
    String? error,
  }) {
    return ChildState(
      status: status ?? this.status,
      children: children ?? this.children,
      error: error,
    );
  }

  @override
  List<Object?> get props => [status, children, error];
}
```

### Step 3: Update HomeScreen to use ChildCubit

Replace direct Firestore calls with Cubit:

```dart
class HomeScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (context) => ChildCubit()..loadChildren(),
      child: const _HomeView(),
    );
  }
}

class _HomeView extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<ChildCubit, ChildState>(
      builder: (context, state) {
        switch (state.status) {
          case ChildStatus.loading:
            return const Center(child: CircularProgressIndicator());
          case ChildStatus.error:
            return ErrorWidget(message: state.error!);
          case ChildStatus.loaded:
            return _buildChildList(state.children);
          default:
            return const SizedBox.shrink();
        }
      },
    );
  }
}
```

---

## Files to Create/Modify

| File | Action |
|------|--------|
| `lib/cubit/child/child_cubit.dart` | Create |
| `lib/cubit/child/child_state.dart` | Create |
| `lib/screens/home/home_screen.dart` | Use ChildCubit |

---

## Progress Tracking

- [x] Create ChildCubit
- [x] Create ChildState
- [x] Update HomeScreen
- [x] Add loading indicators
- [x] Test all functionality
- [x] Update checklist
