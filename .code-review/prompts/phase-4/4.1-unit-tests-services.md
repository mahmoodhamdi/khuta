# Milestone 4.1: Unit Tests for Core Services

> **Phase:** 4 - Testing & Documentation
> **Priority:** HIGH
> **Status:** Pending
> **Last Updated:** 2025-12-27

---

## Problem Description

Core services have zero test coverage:
- SdqScoringService - CRITICAL (scoring logic)
- AiRecommendationsService - CRITICAL (AI logic)
- AssessmentService - HIGH

---

## Required Changes

### Step 1: Create SdqScoringService tests

Create `test/services/sdq_scoring_service_test.dart`:

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:khuta/core/services/sdq_scoring_service.dart';

void main() {
  group('SdqScoringService', () {
    group('calculateTScore', () {
      test('calculates correct T-score for male 6-8 years with score 5', () {
        final tScore = SdqScoringService.calculateTScore(
          answers: [1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
          gender: 'male',
          age: 7,
          assessmentType: 'parent',
        );
        expect(tScore, equals(52));
      });

      test('throws for invalid age', () {
        expect(
          () => SdqScoringService.calculateTScore(
            answers: [1, 1, 1, 1, 1],
            gender: 'male',
            age: 5, // Too young
            assessmentType: 'parent',
          ),
          throwsException,
        );
      });

      test('handles female scoring correctly', () {
        final tScore = SdqScoringService.calculateTScore(
          answers: [2, 2, 2, 2, 2, 0, 0, 0, 0, 0],
          gender: 'female',
          age: 10,
          assessmentType: 'parent',
        );
        expect(tScore, greaterThan(50));
      });
    });

    group('getScoreInterpretation', () {
      test('returns extremely_above_average for tScore >= 70', () {
        final result = SdqScoringService.getScoreInterpretation(75);
        expect(result, contains('above'));
      });

      test('returns average for tScore 45-55', () {
        final result = SdqScoringService.getScoreInterpretation(50);
        expect(result.toLowerCase(), contains('average'));
      });
    });
  });
}
```

### Step 2: Create AiRecommendationsService tests

Create `test/services/ai_recommendations_service_test.dart`:

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:khuta/core/services/ai_recommendations_service.dart';
import 'package:khuta/models/question.dart';

void main() {
  group('AiRecommendationsService', () {
    test('_detectLanguage returns ar for Arabic questions', () {
      final questions = [
        Question(questionText: 'هل يعاني الطفل من صعوبة في التركيز؟', questionType: 'parent'),
      ];
      // Use reflection or make method public for testing
      expect(questions[0].questionText.contains(RegExp(r'[\u0600-\u06FF]')), isTrue);
    });

    test('_getFallbackRecommendations returns correct count for high scores', () {
      // Test fallback recommendations
      final recommendations = AiRecommendationsService.getRecommendations(
        75, // High score
        [], // Empty questions
        [], // Empty answers
      );
      expect(recommendations, isNotEmpty);
    });

    test('_parseRecommendations extracts bullet points', () {
      final text = '''
        - Recommendation 1
        - Recommendation 2
        • Recommendation 3
        1. Recommendation 4
      ''';
      // Test parsing logic
    });
  });
}
```

### Step 3: Create Repository tests with mocks

Create `test/repositories/child_repository_test.dart`:

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/annotations.dart';
import 'package:mockito/mockito.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:khuta/data/repositories/firebase_child_repository.dart';

@GenerateMocks([FirebaseFirestore, FirebaseAuth, User])
void main() {
  group('FirebaseChildRepository', () {
    late MockFirebaseFirestore mockFirestore;
    late MockFirebaseAuth mockAuth;
    late FirebaseChildRepository repository;

    setUp(() {
      mockFirestore = MockFirebaseFirestore();
      mockAuth = MockFirebaseAuth();
      repository = FirebaseChildRepository(
        firestore: mockFirestore,
        auth: mockAuth,
      );
    });

    test('getChildren returns empty list when no children', () async {
      // Setup mocks
      // Assert results
    });
  });
}
```

---

## Run Tests

```bash
# Run all tests
flutter test

# Run with coverage
flutter test --coverage

# Run specific test file
flutter test test/services/sdq_scoring_service_test.dart
```

---

## Acceptance Criteria

- [ ] SdqScoringService has 80%+ coverage
- [ ] AiRecommendationsService has tests for parsing and fallback
- [ ] Repository tests with mocks
- [ ] All tests pass

---

## Progress Tracking

- [ ] Create SdqScoringService tests
- [ ] Create AiRecommendationsService tests
- [ ] Create Repository tests
- [ ] Run coverage report
- [ ] Fix any bugs found
- [ ] Update checklist
