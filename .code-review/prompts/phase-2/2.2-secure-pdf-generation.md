# Milestone 2.2: Secure PDF Generation

> **Phase:** 2 - Security Hardening
> **Priority:** HIGH
> **Status:** Pending
> **Last Updated:** 2025-12-27

---

## Problem Description

The PDF containing sensitive health assessment data is written to the system's temporary directory, which may be accessible to other apps on the device.

### Current Code (lib/screens/child/results_screen.dart)

```dart
Future<void> _shareResultsAsPDF(BuildContext context) async {
  // ...
  final output = await getTemporaryDirectory();  // INSECURE: World-readable
  final file = File(
    '${output.path}/assessment_results_${child.name}_${DateTime.now().millisecondsSinceEpoch}.pdf',
  );
  await file.writeAsBytes(await pdf.save());
  // ...
}
```

---

## Required Changes

### Step 1: Read the current implementation

```
Read: D:\khuta\lib\screens\child\results_screen.dart
```

### Step 2: Use app-specific private directory

Update the PDF generation to use private storage:

```dart
import 'package:path_provider/path_provider.dart';

Future<void> _shareResultsAsPDF(BuildContext context) async {
  try {
    // Show loading
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(child: CircularProgressIndicator()),
    );

    // Generate PDF content
    final pdf = pw.Document();
    // ... PDF generation code ...

    // Use app-specific private directory instead of temp
    final output = await getApplicationDocumentsDirectory();
    final pdfDir = Directory('${output.path}/reports');

    // Create reports directory if it doesn't exist
    if (!await pdfDir.exists()) {
      await pdfDir.create(recursive: true);
    }

    // Sanitize child name for filename
    final sanitizedName = child.name.replaceAll(RegExp(r'[^\w\s-]'), '_');
    final timestamp = DateTime.now().millisecondsSinceEpoch;
    final fileName = 'assessment_${sanitizedName}_$timestamp.pdf';

    final file = File('${pdfDir.path}/$fileName');
    await file.writeAsBytes(await pdf.save());

    // Close loading dialog
    if (context.mounted) Navigator.pop(context);

    // Share the PDF
    await SharePlus.instance.share(
      ShareParams(
        files: [XFile(file.path)],
        text: '${'assessment_results_for'.tr()} ${child.name}',
        subject: 'assessment_results'.tr(),
      ),
    );

    // Delete the file after sharing (optional, for extra security)
    // Uncomment if you want to delete after sharing:
    // await Future.delayed(const Duration(seconds: 5));
    // if (await file.exists()) await file.delete();

  } catch (e) {
    if (context.mounted) {
      Navigator.pop(context);
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('error_generating_pdf'.tr()),
          backgroundColor: Colors.red,
        ),
      );
    }
    debugPrint('Error generating PDF: $e');
  }
}
```

### Step 3: Add cleanup for old reports (optional)

Add a method to clean up old PDF files:

```dart
Future<void> _cleanupOldReports() async {
  try {
    final output = await getApplicationDocumentsDirectory();
    final pdfDir = Directory('${output.path}/reports');

    if (await pdfDir.exists()) {
      final files = pdfDir.listSync();
      final now = DateTime.now();

      for (var file in files) {
        if (file is File) {
          final stat = await file.stat();
          final age = now.difference(stat.modified);

          // Delete files older than 24 hours
          if (age.inHours > 24) {
            await file.delete();
          }
        }
      }
    }
  } catch (e) {
    debugPrint('Error cleaning up reports: $e');
  }
}
```

### Step 4: Sanitize child name in filename

The child's name is used in the filename, which could contain special characters. Ensure it's sanitized:

```dart
String _sanitizeFileName(String name) {
  // Remove special characters, keep alphanumeric, spaces, and hyphens
  return name
      .replaceAll(RegExp(r'[^\w\s-]'), '_')
      .replaceAll(RegExp(r'\s+'), '_')
      .toLowerCase();
}
```

---

## Security Improvements

1. **Private Storage**: Use `getApplicationDocumentsDirectory()` instead of `getTemporaryDirectory()`
2. **Filename Sanitization**: Prevent path traversal attacks
3. **Automatic Cleanup**: Remove old PDF files
4. **Error Handling**: Proper error handling for file operations

---

## Acceptance Criteria

- [ ] PDFs stored in app-private directory
- [ ] Child names sanitized in filenames
- [ ] Old reports cleaned up automatically
- [ ] Share functionality still works
- [ ] `flutter analyze` passes

---

## Files to Modify

| File | Action |
|------|--------|
| `lib/screens/child/results_screen.dart` | Use private storage, sanitize names |

---

## Testing

1. Generate a PDF report
2. Verify file is created in app documents directory (not temp)
3. Verify sharing still works
4. Verify special characters in child names don't break filename
5. Test on both Android and iOS

---

## Progress Tracking

- [ ] Step 1: Read current implementation
- [ ] Step 2: Update storage location
- [ ] Step 3: Add cleanup method
- [ ] Step 4: Sanitize filenames
- [ ] Step 5: Test PDF generation
- [ ] Step 6: Update checklist

---

## Completion

When done, update:
1. `.code-review/MASTER_PLAN.md` - Change milestone 2.2 status to "Done"
2. `.code-review/checklists/phase-2-checklist.md` - Mark item complete
