# Milestone 2.1: Firebase App Check Production Setup

> **Phase:** 2 - Security Hardening
> **Priority:** HIGH
> **Status:** Pending
> **Last Updated:** 2025-12-27

---

## Problem Description

The app currently uses `AndroidDebugProvider()` for Firebase App Check in all builds. This allows app spoofing and unauthorized access to Firebase resources in production.

### Current Code (lib/main.dart)

```dart
await FirebaseAppCheck.instance.activate(
  providerAndroid: const AndroidDebugProvider(),  // DEBUG ONLY!
);
```

---

## Required Changes

### Step 1: Read current configuration

```
Read: D:\khuta\lib\main.dart
Read: D:\khuta\lib\firebase_options.dart
```

### Step 2: Create environment configuration

Create a new file `lib/core/config/app_config.dart`:

```dart
import 'package:flutter/foundation.dart';

class AppConfig {
  /// Returns true if running in debug/development mode
  static bool get isDebug => kDebugMode;

  /// Returns true if running in release/production mode
  static bool get isProduction => kReleaseMode;

  /// Returns true if running in profile mode
  static bool get isProfile => kProfileMode;
}
```

### Step 3: Update Firebase App Check initialization

Update `lib/main.dart`:

```dart
import 'package:firebase_app_check/firebase_app_check.dart';
import 'core/config/app_config.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await EasyLocalization.ensureInitialized();

  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

  // Configure App Check based on environment
  await FirebaseAppCheck.instance.activate(
    providerAndroid: AppConfig.isDebug
        ? const AndroidDebugProvider()
        : const AndroidPlayIntegrityProvider(),
    providerApple: AppConfig.isDebug
        ? const AppleDebugProvider()
        : const AppleDeviceCheckProvider(),
    providerWeb: const ReCaptchaV3Provider('YOUR_RECAPTCHA_SITE_KEY'),
  );

  // Rest of initialization...
}
```

### Step 4: Configure Play Integrity API

For Android production:

1. Go to Google Cloud Console
2. Enable Play Integrity API
3. Go to Firebase Console > App Check
4. Register your app with Play Integrity
5. Get the SHA-256 fingerprint: `./gradlew signingReport`

### Step 5: Configure Device Check for iOS

For iOS production:

1. Go to Apple Developer Portal
2. Enable Device Check capability
3. Go to Firebase Console > App Check
4. Register your app with Device Check

### Step 6: Add debug token for development (optional)

For CI/CD or testing:

```dart
if (AppConfig.isDebug) {
  // Get debug token from Firebase Console > App Check > Apps > Debug Token
  // Only for local development, never commit actual tokens
}
```

---

## Firebase Console Setup

### Android (Play Integrity)

1. Firebase Console > App Check
2. Click your Android app
3. Select "Play Integrity"
4. Add SHA-256 certificate fingerprint
5. Save

### iOS (Device Check)

1. Firebase Console > App Check
2. Click your iOS app
3. Select "DeviceCheck"
4. Enter your Team ID
5. Save

---

## Acceptance Criteria

- [ ] Debug builds use debug providers
- [ ] Release builds use production providers (Play Integrity / Device Check)
- [ ] App Check enforced in Firebase Console
- [ ] App works correctly in both modes
- [ ] `flutter analyze` passes

---

## Files to Modify

| File | Action |
|------|--------|
| `lib/main.dart` | Update App Check initialization |
| `lib/core/config/app_config.dart` | Create new file |

---

## Testing

### Debug Mode
```bash
flutter run --debug
# Should use AndroidDebugProvider/AppleDebugProvider
```

### Release Mode
```bash
flutter run --release
# Should use AndroidPlayIntegrityProvider/AppleDeviceCheckProvider
```

---

## Security Notes

- NEVER use debug providers in production
- Store reCAPTCHA keys securely (not in source code for web)
- Enable App Check enforcement in Firebase Console after testing
- Monitor App Check metrics in Firebase Console

---

## Progress Tracking

- [ ] Step 1: Read current config
- [ ] Step 2: Create AppConfig class
- [ ] Step 3: Update App Check initialization
- [ ] Step 4: Configure Play Integrity
- [ ] Step 5: Configure Device Check
- [ ] Step 6: Test both modes
- [ ] Step 7: Update checklist

---

## Completion

When done, update:
1. `.code-review/MASTER_PLAN.md` - Change milestone 2.1 status to "Done"
2. `.code-review/checklists/phase-2-checklist.md` - Mark item complete
